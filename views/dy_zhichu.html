<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的生活账本-支出</title>
    <link rel="stylesheet" href="../vendor/bootstrap/css/bootstrap.css"/>
    <link rel="stylesheet" href="../dist/css/bootstrapValidator.css"/>
    <link href="../css/bootstrap-datetimepicker.min.css" rel="stylesheet">
    <style>
        .dask {
            width:250px;
            height:80px;
            /*上内边距:10px;右内边距:0;下内边距:0;左边距:30px;*/
            padding:10px 0 0 30px;
            background: rgba(103, 103, 103, 0.75);
            opacity:0.8;
            position:absolute;
            top:-200px;
            left:0;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Modal 花费明细 -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <!-- modal-sm来改变模态框的大小 -->
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">支出明细</h4>
                    </div>
                    <div class="modal-body">
                        <!-- 具体明细内容-->
                        <p hidden id="modal_id"></p>
                        <p><strong>花费地点：</strong><span id="hfaddress"></span></p>
                        <p><strong>消费：</strong><span  id="hfcontent"></span></p>
                        <p><strong>消费金额：</strong><span id="hfmoney"></span></p>
                        <p><strong>备注：</strong><pre id="hfmark"></pre></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-danger" onclick="del()">确认删除</button>
                    </div>
                </div>
            </div>
        </div>
        <!--顶部-->
        <div class="col-lg-offset-2  col-lg-8">
            <nav>
                <ul class="nav nav-tabs pull-right">
                    <li >
                        <a href="home.html"><span class="glyphicon glyphicon-tasks"></span>我的生活账本</a>
                    </li>
                    <li >
                        <a id="today_date"><span class="glyphicon glyphicon-time" ></span><%=today_date%></a>
                    </li>
                </ul>
            </nav>
            <h3 class="text-muted">DailyRecord--记录点滴生活</h3>
        </div>

        <!-- 导航条-->
        <div class="col-lg-offset-2  col-lg-8">
            <nav class="navbar-default">
                <ol class="breadcrumb">
                    <li><span class="glyphicon glyphicon-home"></span><a href="#">Home</a></li>
                    <li><a href="home.html">我的生活账本</a></li>
                    <li class="active">支出</li>
                </ol>
            </nav>
        </div>

        <!-- form表单内容-->
        <div class="col-lg-offset-2 col-lg-5">
            <form class="form-horizontal" id="zhichuForm" action="/zhichu/add">
                <div class="form-group">
                    <div class="col-lg-5 col-lg-offset-2">
                        <div class="input-group">
                            <span class="input-group-addon"><span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span></span>
                            <input type="text" name="hfplace" class="form-control" placeholder="地点">
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="input-group date form_datetime"  data-date-format="dd MM yyyy" data-link-field="dtp_input1">
                            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                            <input class="form-control" name="date" type="text" value="" data-date="" data-date-format="dd MM yyyy" readonly>
                            <!-- 后台获取数据的-->
                            <input type="hidden" name="hfdate" id="dtp_input1" value="" />
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-lg-2 control-label">*分类</label>
                    <div class="col-lg-10">
                        <select class="form-control" name="hfkind">
                            <option value="">-------------------------请选择-------------------------</option>
                            <option value="1">一日三餐</option>
                            <option value="2">日常用品</option>
                            <option value="3">交通</option>
                            <option value="4">衣着</option>
                            <option value="5">生活其他</option>
                            <option value="6">书籍</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-lg-2 control-label">*消费</label>
                    <div class="col-lg-10">
                        <input type="text" class="form-control" name="hfcontent" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-lg-2 control-label  col-lg-offset-0">*金额</label>
                    <div class="col-lg-5">
                        <div class=" input-group">
                            <input type="text" class="form-control" name="hfmoney" />
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button">元</button>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-lg-2 control-label">备注</label>
                    <div class="col-lg-10">
                        <textarea class="form-control" name="hfmark" rows="5"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-lg-10 col-lg-offset-2">
                        <label>
                            <input type="checkbox" class="checkbox-inline" value="1" name="hfstar">
                            <span class="label label-danger">标注此账目</span>
                        </label>
                        <button type="button" onclick="validateSubmit(this.form)" style="margin-left: 50px" id="validateBtn" class="btn btn-primary">保存</button>
                        <span class="label label-danger col-lg-offset-2">*为必填项</span>
                    </div>
                </div>
            </form>
        </div>

        <!-- 列表栏-->
        <div class="col-lg-offset-0  col-lg-3">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <span style="margin-left: 10px;" id="show_hf_date">今日消费</span>

                    <strong class="pull-right" id="total_money">总计：<%=today_money%>元</strong>
                </div>
                <div class="panel-body list-group" id="today_hf">

                    <!-- 列出今日消费的内容-->
                    <% if(data.length) {
                    data.forEach(function(detail){ %>
                    <li class="list-group-item" style="overflow:hidden;" id=<%=detail.HF_ID%> >
                       <%=detail.HF_CONTENT%>
                            <span class="label label-danger pull-right">-<%=detail.HF_MONEY%>元</span>
                        <div class="dask">
                            <button  class="btn btn-primary" style="margin-left: 20px;">编辑</button>
                            <button class="btn btn btn-warning" onclick="showDetail('<%=detail.HF_ID%>')">删除</button>
                        </div>
                    </li>

                    <% })
                    }else{ %>
                    <span class="list-group-item" id="no_hf">今日还未有消费内容</span>
                    <%
                    }  %>
                    <!--<a href="#" class="list-group-item">早餐<span class="label label-danger pull-right">-12元</span></a>-->
                    <!--<a href="#" class="list-group-item">中餐<span class="label label-danger pull-right">-18元</span></a>-->
                    <!--<a href="#" class="list-group-item">JS程序设计<span class="label label-danger pull-right">-62.4元</span></a>-->
                    <!--<a href="#" class="list-group-item">厨房用品+零食<span class="label label-danger pull-right">-40.4元</span></a>-->
                    <!--<a href="#" class="list-group-item">怡宝矿泉水<span class="label label-danger pull-right">-7元</span></a>-->
                    <!--<a href="#" class="list-group-item">话费<span class="label label-danger pull-right">-7元</span></a>-->

                    <div class="pull-right">
                        <ul class="pagination pagination-sm" style="margin-bottom: 0px;">
                            <li><a href="#">&uparrow;</a></li>
                            <li><a href="#">&downarrow;</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="../vendor/jquery/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="../vendor/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../dist/js/bootstrapValidator.js"></script>
    <script src="../js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/angular.min.js"></script>

    <script type="text/javascript">

        //删除时查看消费具体明细
        function showDetail(HF_ID){
            $.ajax({
                type:'POST',
                url:"/zhichu/detail",
                data:{HF_ID:HF_ID},
                dataType:'json',
                success:function(data){
                    if(data){
                        $("#hfaddress").empty();
                        $("#hfcontent").empty();
                        $("#hfmoney").empty();
                        $("#hfmark").empty();
                        $("#modal_id").empty();
                        $("#modal_id").append(data[0].HF_ID);
                        $("#hfaddress").append(data[0].HF_ADDRESS);
                        $("#hfcontent").append(data[0].HF_CONTENT);
                        $("#hfmoney").append(data[0].HF_MONEY);
                        $("#hfmark").append(data[0].HF_MARK);
                        $('#myModal').modal('show');
                    }
                }
            });
        }

//        删除
//        today_hf
        function del(){
            var HF_ID = $("#modal_id").text();
            var HF_DEL = "#"+HF_ID;
            var HF_MONEY = $("#hfmoney").text();
            var total_money = $("#total_money").text().replace(/[^\d.]/g,'');
            $.ajax({
                type:'POST',
                url:"/zhichu/del",
                data:{HF_ID:HF_ID},
                dataType:'json',
                success:function(data){
                    if(data){
                        $('#myModal').modal('hide');
                        setTimeout( $(HF_DEL).remove(),1000);
                        if($("#today_hf").find("li").length==2){
                            var $sapn = $('<span>',{
                                text:'今日还未有消费内容',
                                class:'list-group-item',
                                id:'no_hf'
                            });

                            $("#today_hf").prepend($sapn);
                        }
                        total_money = parseFloat(total_money)-parseFloat(HF_MONEY);
                        total_money = total_money.toFixed(2);
                        $("#total_money").text(total_money+'元');
                    }
                }
            });

        }


        //        鼠标悬停触发事件
        $(".list-group-item").hover(
                function () {
                    $(this).find(".dask").stop().delay(50).animate({"top":0,opacity:0.5},300)
                },
                function () {
                    $(this).find(".dask").stop().animate({"top":-200,opacity:0},300)
                }

        );

//       日期插件的属性设置
        $('.form_datetime').datetimepicker({
            language:  'en',
            weekStart: 1,
            todayBtn:  1,
            autoclose: 1,
            todayHighlight: 1,
            startView: 2,
            forceParse: 0,
            showMeridian: 1,
//            endDate:new Date(),//只能选择今天之前的日期
            minView: 2//不弹出小时，只能选择到天
        });
//      表单验证
        $(document).ready(function() {
            $('#zhichuForm').bootstrapValidator({
//        live: 'disabled',
                message: 'This value is not valid',
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {
                    hfcontent: {
                        validators: {
                            notEmpty: {
                                message: '请输入消费商品'
                            }
                        }
                    },
                    hfkind: {
                        validators: {
                            notEmpty: {
                                message: '请选择消费种类'
                            }
                        }
                    },
                    hfmoney: {
                        validators: {
                            notEmpty: {
                                message: '请选择消费金额'
                            },
                            numbers: {
                                message: '请输入数字'
                            }
                        }
                    },
                    hfplace:{
                        validators: {}
                    },
                    date:{
                        validators: {}
                    },
                    hfmark:{
                        validators: {
                            stringLength: {
                                max: 250,
                                message: '请输入少于250个字'
                            }
                        }

                    }


                }
            });
        });

        function validateSubmit(form) {
            var date = now_date();
            $('#zhichuForm').bootstrapValidator('validate');
            if ($('#zhichuForm').data('bootstrapValidator').isValid()) {
                var total_money = $("#total_money").text().replace(/[^\d.]/g,'');
                var data = {};
                $("#zhichuForm").serializeArray().map(function(x){data[x.name] = x.value;});
                var zcForm = data;
                //如果不是添加当前的项目，则要对获取的日期进行判断
                if(isSampleDay()){
                    addToday(zcForm,1);
                }
                else{
                    addNotToday(zcForm,0,date);
                }

            }
    }

//   如果不是同一天
    function addNotToday(zcForm,today_flag,date){
        $.ajax({
            type:'POST',
            url:"/zhichu/add",
            data:{zcForm: zcForm,today_flag:today_flag},
            dataType:'json',
            success:function(data){
                if(data){
//                  重置表单
                    $('#zhichuForm').bootstrapValidator("resetForm",true);
                    $("#today_hf").children(".list-group-item").remove();
                    var total_money = 0;
                    for(i=0;i<data.length;i++){
                        total_money += parseFloat(data[i].HF_MONEY);
                        appendDiv(data[i]);
                    }
//                  保留小数点后两位
                    total_money = total_money.toFixed(2);
                    $("#total_money").text(total_money+'元');
                    $("#show_hf_date").text(date);

                }
            }
        });
    }

//   如果是同一天则调用这个方法,
    function addToday(zcForm,today_flag){
        var total_money = $("#total_money").text().replace(/[^\d.]/g,'');
        $.ajax({
            type:'POST',
            url:"/zhichu/add",
            data:{zcForm: zcForm,today_flag:today_flag},
            dataType:'json',
            success:function(data){
                if(data){
//                        重置表单,并且只能对验证的字段进行重置
                    $('#zhichuForm').bootstrapValidator("resetForm",true);
                    $('#no_hf').remove();
//                        调用方法，插入
                    appendDiv(data);
//                       修改今日消费的money
                    total_money = parseFloat(total_money)+parseFloat(data.HF_MONEY);
                    $("#total_money").text(total_money+'元');
                }
            }
        });
    }

//  把一些DOM操作封装
    function appendDiv(data){
        var $li = $('<li>',{
            class:'list-group-item',
            style:'overflow:hidden',
            text:data.HF_CONTENT,
            id:data.HF_ID
        });
//            var $li =  $('<li class="list-group-item" id="li_detail" style=" overflow:hidden;">');
        var $span = $('<span>',{
            class:'label label-danger pull-right',
            text:'-'+data.HF_MONEY+'元'
        });


        var $div = $('<div>',{
            class:"dask"
        });

        var $update = $('<button>',{
            class:'btn btn-primary',
            style:'margin-left: 20px;',
            text:'编辑'
        });


        var $del = $('<button>',{
            class:'btn btn btn-warning',
            style:'margin-left: 5px;',
            text:'删除'
        });
        $del.click(function(event){
            event.preventDefault();
            $del.onclick = showDetail(data.HF_ID);
        });
        $div.append($update);
        $div.append($del);
        $li.append($span);
        $li.append($div);

        $li.hover(
                function () {
                    $(this).find(".dask").stop().delay(50).animate({"top":0,opacity:0.5},300)
                },
                function () {
                    $(this).find(".dask").stop().animate({"top":-200,opacity:0},300)
                }
        );
        $("#today_hf").prepend($li);
    }


//  判断添加的是否和左侧列表栏的日期相符合（没有数据默认符合）
        function isSampleDay(){
//            获取日期，如果为今日消费就是今天的日期
            var today =  $("#show_hf_date").text();

            if($("#show_hf_date").text().toString()=="今日消费"){
                today = new Date().toLocaleDateString();
            }
//          获取日期输入框的值
            var reg=new RegExp("-","g");
            var input_date = $("#dtp_input1").val().substring(0,10).replace(reg,"/");

//          getTime()方法，就可以返回日期对应的数值
            var today1 = new Date(today).getTime();
            var input_date1 =  new Date(input_date).getTime();

            if((today1==input_date1) || ($("#dtp_input1").val().length==0)){
               return true;
            }else{
               return false;
            }
        }

//       如果是今日，则改为今日消费，否则返回日期
        function now_date(){
            var today = new Date().toLocaleDateString();
            var reg=new RegExp("-","g");
            var input_date = $("#dtp_input1").val().substring(0,10).replace(reg,"/");
            var today1 = new Date(today).getTime();
            var input_date1 =  new Date(input_date).getTime();
            if(today1==input_date1){
                return "今日消费"
            }else{
                return  input_date;
            }
        }
    </script>

</body>
</html>