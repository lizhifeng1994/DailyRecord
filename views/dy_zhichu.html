<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的生活账本-支出</title>
    <link rel="stylesheet" href="../vendor/bootstrap/css/bootstrap.css"/>
    <link rel="stylesheet" href="../dist/css/bootstrapValidator.css"/>
    <link href="../css/bootstrap-datetimepicker.min.css" rel="stylesheet">
    <style>
        .dask {
            width:250px;
            height:80px;
            /*上内边距:10px;右内边距:0;下内边距:0;左边距:30px;*/
            padding:10px 0 0 30px;
            background: rgba(103, 103, 103, 0.75);
            opacity:0.8;
            position:absolute;
            top:-200px;
            left:0;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Modal 花费明细 -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <!-- modal-sm来改变模态框的大小 -->
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">支出明细</h4>
                    </div>
                    <div class="modal-body">
                        <!-- 具体明细内容-->
                        <p><strong>花费地点：</strong><span id="hfaddress"></span></p>
                        <p><strong>消费：</strong><span  id="hfcontent"></span></p>
                        <p><strong>消费金额：</strong><span id="hfmoney"></span></p>
                        <p><strong>备注：</strong><pre id="hfmark"></pre></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-danger" id="del">确认删除</button>
                    </div>
                </div>
            </div>
        </div>
        <!--顶部-->
        <div class="col-lg-offset-2  col-lg-8">
            <nav>
                <ul class="nav nav-tabs pull-right">
                    <li >
                        <a href="/home"><span class="glyphicon glyphicon-tasks"></span>我的生活账本</a>
                    </li>
                    <li >
                        <a id="today_date"><span class="glyphicon glyphicon-time" ></span><%=today_date%></a>
                    </li>
                </ul>
            </nav>
            <h3 class="text-muted">DailyRecord--记录点滴生活</h3>
        </div>

        <!-- 导航条-->
        <div class="col-lg-offset-2  col-lg-8">
            <nav class="navbar-default">
                <ol class="breadcrumb">
                    <li><span class="glyphicon glyphicon-home"></span><a>Home</a></li>
                    <li><a href="/home">我的生活账本</a></li>
                    <li class="active">支出</li>
                </ol>
            </nav>
        </div>

        <!-- form表单内容-->
        <div class="col-lg-offset-2 col-lg-5">
            <form class="form-horizontal" id="zhichuForm" action="/zhichu/add">
                <div class="form-group">
                    <div class="col-lg-5 col-lg-offset-2">
                        <div class="input-group">
                            <span class="input-group-addon"><span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span></span>
                            <input type="text" name="hfplace" class="form-control" placeholder="地点">
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="input-group date form_datetime"  data-date-format="dd MM yyyy" data-link-field="dtp_input1">
                            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                            <input class="form-control" name="date" type="text" value="" data-date="" data-date-format="dd MM yyyy" readonly>
                            <!-- 后台获取数据的-->
                            <input type="hidden" name="hfdate" id="dtp_input1" value="" />
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-lg-2 control-label">*分类</label>
                    <div class="col-lg-10">
                        <select class="form-control" name="hfkind">
                            <option value="">-------------------------请选择-------------------------</option>
                            <option value="1">一日三餐</option>
                            <option value="2">日常用品</option>
                            <option value="3">交通</option>
                            <option value="4">衣着</option>
                            <option value="5">生活其他</option>
                            <option value="6">书籍</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-lg-2 control-label">*消费</label>
                    <div class="col-lg-10">
                        <input type="text" class="form-control" name="hfcontent" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-lg-2 control-label  col-lg-offset-0">*金额</label>
                    <div class="col-lg-5">
                        <div class=" input-group">
                            <input type="text" class="form-control" name="hfmoney" />
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button">元</button>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-lg-2 control-label">备注</label>
                    <div class="col-lg-10">
                        <textarea class="form-control" name="hfmark" rows="5"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-lg-10 col-lg-offset-2">
                        <label>
                            <input type="checkbox" class="checkbox-inline" value="1" name="hfstar">
                            <span class="label label-danger">标注此账目</span>
                        </label>
                        <button type="button" onclick="validateSubmit()" style="margin-left: 20px" id="validateBtn" class="btn btn-primary">保存</button>
                        <button type="button" onclick="clean()" style="margin-left: 10px" class="btn btn-primary">撤销</button>
                        <span class="label label-danger col-lg-offset-1">*为必填项</span>
                    </div>
                </div>
            </form>
        </div>

        <!-- 列表栏-->
        <div class="col-lg-offset-0  col-lg-3">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <span style="margin-left: 10px;" id="show_hf_date">今日消费</span>
                    <strong class="pull-right" id="total_money">总计：<%=today_money%>元</strong>
                    <p hidden id="pageNow"><%=pageNow%></p>
                </div>
                <div class="panel-body list-group" id="today_hf">

                    <!-- 列出今日消费的内容-->
                    <% if(data.length) {
                    data.forEach(function(detail){ %>
                    <li class="list-group-item" style="overflow:hidden;" id=<%=detail.HF_ID%> >
                       <b><%=detail.HF_CONTENT%></b>
                            <span class="label label-danger pull-right">-<%=detail.HF_MONEY%>元</span>
                        <div class="dask">
                            <button  class="btn btn-primary" onclick="fillForm('<%=detail.HF_ID%>')" style="margin-left: 20px;">编辑</button>
                            <button class="btn btn btn-warning" onclick="showDetail('<%=detail.HF_ID%>')">删除</button>
                        </div>
                    </li>

                    <% })
                    }else{ %>
                    <span class="list-group-item" id="no_hf">今日还未有消费内容</span>
                    <%
                    }  %>
                    <div class="pull-right">
                        <ul class="pagination pagination-sm" style="margin-bottom: 0px;">
                            <li><a onclick="pageUp()">&uparrow;</a></li>
                            <li><a onclick="pageDown()">&downarrow;</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="../vendor/jquery/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="../vendor/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../dist/js/bootstrapValidator.js"></script>
    <script src="../js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/angular.min.js"></script>
    <script type="text/javascript" src="../js/comm.js"></script>
    <script type="text/javascript">

//      删除时查看消费具体明细
        function showDetail(HF_ID){
            $.ajax({
                type:'POST',
                url:"/zhichu/detail",
                data:{HF_ID:HF_ID},
                dataType:'json',
                success:function(data){
                    if(data){
                        $("#hfaddress").empty();
                        $("#hfcontent").empty();
                        $("#hfmoney").empty();
                        $("#hfmark").empty();
                        $("#modal_id").empty();

                        $("#modal_id").append(data[0].HF_ID);
                        $("#hfaddress").append(data[0].HF_ADDRESS);
                        $("#hfcontent").append(data[0].HF_CONTENT);
                        $("#hfmoney").append(data[0].HF_MONEY);
                        $("#hfmark").append(data[0].HF_MARK);
                        $('#myModal').modal('show');
                        $("#del").attr("onclick","del("+HF_ID+")");
//                        $("#del").click(function(event){
//                            event.preventDefault();
//                            $("#del").onclick = del(HF_ID);
//                        });
                    }
                }
            });
        }

//        删除
        function del(HF_ID){
            var HF_DEL = "#"+HF_ID;
            var HF_MONEY = $("#hfmoney").text();
            var total_money = $("#total_money").text().replace(/[^\d.]/g,'');
            $.ajax({
                type:'POST',
                url:"/zhichu/del",
                data:{HF_ID:HF_ID},
                dataType:'json',
                success:function(data){
                    if(data){
                        $('#myModal').modal('hide');
                        setTimeout( $(HF_DEL).remove(),1000);
                        if($("#today_hf").find("li").length==2){
                            if(parseInt($("#pageNow").text())!=1){
                                pageUp();
                            }else{
                                var $sapn = $('<span>',{
                                    text:'今日还未有消费内容',
                                    class:'list-group-item',
                                    id:'no_hf'
                                });

                                $("#today_hf").prepend($sapn);
                            }

                        }
//                      如果有5条记录，你删除的时候再去找
                        if(($("#today_hf").find("li").length-2)==4){
                            isNext($("#today_hf").find("li")[3].getAttribute("id"));
                        }

                        total_money = parseFloat(total_money)-parseFloat(HF_MONEY);
                        total_money = total_money.toFixed(2);
                        $("#total_money").text("总计："+total_money+'元');
                    }
                }
            });

        }

//      编辑
        function update(HF_ID,HF_MONEY) {
            var zcForm = serializeForm();

            $('#zhichuForm').bootstrapValidator('validate');
            if ($('#zhichuForm').data('bootstrapValidator').isValid()) {
                if ((document.getElementById(HF_ID) != null)) {
//                进行更新
                    if (isSampleDay()) {
//                   update
                        console.log("进来编辑")
                        $.ajax({
                            type: 'POST',
                            url: "/zhichu/update",
                            data: {zcForm: zcForm, HF_ID: HF_ID},
                            dataType: 'json',
                            success: function (data) {
                                if (data) {
//                               console.log("编辑成功"+data[0].HF_ID);
                                console.log("数据库"+data.HF_MONEY);
                                console.log("传过来的"+HF_MONEY);

                                    var diff = parseFloat(data.HF_MONEY) - parseFloat(HF_MONEY);

                                    var total_money = $("#total_money").text();

                                    total_money = parseFloat(total_money.substring(3, total_money.length));

                                    total_money = total_money + diff;

                                    total_money = total_money.toFixed(2);

                                    var temp_HF_ID = "#" + HF_ID;

                                    $(temp_HF_ID).find("span").text("-" + data.HF_MONEY + "元");

                                    $(temp_HF_ID).find("b").text(data.HF_CONTENT);

                                    $("#total_money").text("总计：" + total_money + '元');

                                    clean();
                                }
                            }
                        });
                    } else {
//                   如果你修改了日期
                        var date = now_date();
                        del(HF_ID);
                        addNotToday(zcForm, 0, date);

                        $("#validateBtn").attr("onclick",validateSubmit());

                        $("#validateBtn").text("保存");
                    }
                } else {
//                console.log("不存在");
//                进行新增
                    validateSubmit();
//                    $("#validateBtn").click(function (event) {
//                        event.preventDefault();
//                        $("#validateBtn").onclick = validateSubmit();
//                    });

                    $("#validateBtn").attr("onclick",validateSubmit());

                    $("#validateBtn").text("保存");
                }

            }
        }

//       点击编辑，获得内容，填充表单
        function fillForm(HF_ID){
//            console.log(document.getElementsByName("hfmoney"));
            $.ajax({
                type:'POST',
                url:"/zhichu/detail",
                data:{HF_ID:HF_ID},
                dataType:'json',
                success:function(data){
                    if(data){
                        $("input[name='hfmoney']").val(data[0].HF_MONEY);

                        $("select[name='hfkind']").val(data[0].HF_KIND);

                        $("input[name='hfcontent']").val(data[0].HF_CONTENT);

                        $("textarea[name='hfmark']").val(data[0].HF_MARK);

                        $("input[name='hfplace']").val(data[0].HF_ADDRESS);

                        $("input[name='date']").val(data[0].HF_DATE);

                        if(data[0].HF_STAR==1){
                            console.log(data[0].HF_STAR);
                            $("input[name='hfstar']").prop("checked",true);
                        }

                        $("#validateBtn").removeAttr("onclick");

                        $("#validateBtn").attr("onclick","update("+HF_ID+","+data[0].HF_MONEY+")");

                        $("#validateBtn").text("编辑");

//                        $("#validateBtn").attr("onclick","update(HF_ID)");
//                        console.log($("#validateBtn"));
                    }
                }
            });
        }

//        鼠标悬停触发事件
        $(".list-group-item").hover(
                function () {
                    $(this).find(".dask").stop().delay(50).animate({"top":0,opacity:0.5},300)
                },
                function () {
                    $(this).find(".dask").stop().animate({"top":-200,opacity:0},300)
                }

        );

//       日期插件的属性设置
        $('.form_datetime').datetimepicker({
//            language:  'en',
            weekStart: 1,
            todayBtn:  1,
            autoclose: 1,
            todayHighlight: 1,
            startView: 2,
            forceParse: 0,
            showMeridian: 1,
//            endDate:new Date(),//只能选择今天之前的日期
            minView: 2//不弹出小时，只能选择到天
        });

//      表单验证
        $(document).ready(function() {
            $('#zhichuForm').bootstrapValidator({
//        live: 'disabled',
                message: 'This value is not valid',
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {
                    hfcontent: {
                        validators: {
                            notEmpty: {
                                message: '请输入消费商品'
                            }
                        }
                    },
                    hfkind: {
                        validators: {
                            notEmpty: {
                                message: '请选择消费种类'
                            }
                        }
                    },
                    hfmoney: {
                        validators: {
                            notEmpty: {
                                message: '请选择消费金额'
                            },
                            regexp: {
                                regexp: /^\+?(:?(:?\d+\.\d+)|(:?\d+))$/,
                                message: '请填写正确的数字格式'
                            },
                        }
                    },
                    hfplace:{
                        validators: {}
                    },
                    date:{
                        validators: {}
                    },
                    hfstar:{
                        validators: {}
                    },
                    hfmark:{
                        validators: {
                            stringLength: {
                                max: 250,
                                message: '请输入少于250个字'
                            }
                        }

                    }
                }
            });
        });

//      增加
        function validateSubmit() {
            var date = now_date();
           $('#zhichuForm').bootstrapValidator('validate');

            if ($('#zhichuForm').data('bootstrapValidator').isValid()) {
                var total_money = $("#total_money").text().replace(/[^\d.]/g,'');
//                var data = {};
//                $("#zhichuForm").serializeArray().map(function(x){data[x.name] = x.value;});
                var zcForm = serializeForm();
                //如果不是添加当前的项目，则要对获取的日期进行判断
                if(isSampleDay()){
                    addToday(zcForm,1);
                }
                else{
                    addNotToday(zcForm,0,date);
                }
            }
    }

//   如果不是同一天
    function addNotToday(zcForm,today_flag,date){
        $.ajax({
            type:'POST',
            url:"/zhichu/add",
            data:{zcForm: zcForm,today_flag:today_flag},
            dataType:'json',
            success:function(data){
                if(data){
//                  重置表单
                    $('#zhichuForm').bootstrapValidator("resetForm",true);
                    $("#today_hf").children(".list-group-item").remove();
                    var total_money = 0;
                    for(i=0;i<data.length;i++){
                        total_money += parseFloat(data[i].HF_MONEY);
                        appendDiv(data[i]);
                    }
//                  保留小数点后两位
                    total_money = total_money.toFixed(2);
                    $("#total_money").text("总计:"+total_money+'元');
                    $("#show_hf_date").text(date);

                }
            }
        });
    }

//   如果是同一天则调用这个方法,
    function addToday(zcForm,today_flag){
        var total_money = $("#total_money").text().replace(/[^\d.]/g,'');
        $.ajax({
            type:'POST',
            url:"/zhichu/add",
            data:{zcForm: zcForm,today_flag:today_flag},
            dataType:'json',
            success:function(data){
                if(data){
//                        重置表单,并且只能对验证的字段进行重置
                    $('#zhichuForm').bootstrapValidator("resetForm",true);
                    $('#no_hf').remove();
//                        调用方法，插入
                    if(($("#today_hf").find("li").length-2)==5){
                        $("#today_hf").find("li")[4].remove();
                        appendDiv(data);
                    }else{
                        appendDiv(data);
                    }

//                       修改今日消费的money
                    total_money = parseFloat(total_money)+parseFloat(data.HF_MONEY);
                    total_money = total_money.toFixed(2);
                    $("#total_money").text("总计："+total_money+'元');
                }
            }
        });
    }

//  下一页
    function pageDown(){
//      如果本页面有5条记录，这个就是最后一条记录
//        console.log($("#today_hf").find("li")[4]);
//      如果当前消费记录数小于5条，就不需要去请求下一页
//      如果当前页面满了，才下一页

        var date = $("#show_hf_date").text().toString();
        console.log(date);
        if(($("#today_hf").find("li").length-2)==5){
            var pageNow = parseInt($("#pageNow").text())+1;
            $.ajax({
                type:'POST',
                url:"/zhichu/page",
                data:{pageNow:pageNow,date:date},
                dataType:'json',
                success:function(data) {
                    if (data.length != 0) {
                        $("#today_hf").children(".list-group-item").remove();
                        for (i = data.length-1; i >=0; i--) {
                            appendDiv(data[i]);
                        }
//                    console.log(pageNow);
//                    设置新的当前页
                        $("#pageNow").text(pageNow);
//                        console.log("当前页" + $("#pageNow").text());
                    }
                }
            });

        }

    }

//  上一页
    function pageUp(){
        var pageNow = $("#pageNow").text();
        var date = $("#show_hf_date").text().toString();
//      如果当前页就是第一页，就不需要去请求上一页
        if(parseInt(pageNow)>1){
            var pageNow = parseInt($("#pageNow").text())-1;
            $.ajax({
                type:'POST',
                url:"/zhichu/page",
                data:{pageNow:pageNow,date:date},
                dataType:'json',
                success:function(data) {
                    if (data.length != 0) {
                        $("#today_hf").children(".list-group-item").remove();
                        for (i = (data.length-1); i >=0 ; i--) {
                            appendDiv(data[i]);
                        }
//                    console.log(pageNow);
//                    设置新的当前页
                        $("#pageNow").text(pageNow);
                        console.log("当前页" + $("#pageNow").text());

                    }
                }
            });
        }
    }

//  删除时，查看是否有下一条
    function isNext(HF_ID){
        console.log("查看是否有下一条"+HF_ID);
        var date = $("#show_hf_date").text().toString();
        var temp_HF_ID = "#"+HF_ID;
        $.ajax({
           type:'post',
            url:"/zhichu/next",
            data:{HF_ID:HF_ID,date:date},
            dataType:'json',
            success:function(data){
                var last_id = $("#today_hf").find("li")[3].getAttribute("id");
                last_id = "#"+last_id;
                $(last_id).after(productLi(data[0]));
//                $(temp_HF_ID).append(productLi(dat[0]));
//                appendDiv(data[0]);
            }
        });
    }
    </script>

</body>
</html>